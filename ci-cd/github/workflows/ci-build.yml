name: CI - Build and Test

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'bugfix/**'
    paths:
      - 'services/**'
      - 'kubernetes/**'
      - 'helm/**'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'services/**'
      - 'kubernetes/**'
      - 'helm/**'

env:
  AWS_REGION: us-west-2
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-west-2.amazonaws.com
  TRIVY_SEVERITY: HIGH,CRITICAL

jobs:
  # =============================================================================
  # Detect Changes
  # =============================================================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api-gateway: ${{ steps.changes.outputs.api-gateway }}
      user-service: ${{ steps.changes.outputs.user-service }}
      order-service: ${{ steps.changes.outputs.order-service }}
      payment-service: ${{ steps.changes.outputs.payment-service }}
      inventory-service: ${{ steps.changes.outputs.inventory-service }}
      notification-service: ${{ steps.changes.outputs.notification-service }}
      kubernetes: ${{ steps.changes.outputs.kubernetes }}
      helm: ${{ steps.changes.outputs.helm }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            api-gateway:
              - 'services/api-gateway/**'
              - '.github/workflows/ci-build.yml'
            user-service:
              - 'services/user-service/**'
              - '.github/workflows/ci-build.yml'
            order-service:
              - 'services/order-service/**'
              - '.github/workflows/ci-build.yml'
            payment-service:
              - 'services/payment-service/**'
              - '.github/workflows/ci-build.yml'
            inventory-service:
              - 'services/inventory-service/**'
              - '.github/workflows/ci-build.yml'
            notification-service:
              - 'services/notification-service/**'
              - '.github/workflows/ci-build.yml'
            kubernetes:
              - 'kubernetes/**'
            helm:
              - 'helm/**'

  # =============================================================================
  # Build API Gateway
  # =============================================================================
  build-api-gateway:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.api-gateway == 'true' }}
    defaults:
      run:
        working-directory: services/api-gateway
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export to Docker
        uses: docker/build-push-action@v5
        with:
          context: services/api-gateway
          load: true
          tags: api-gateway:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: api-gateway:test
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: ${{ env.TRIVY_SEVERITY }}
          exit-code: '1'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run unit tests
        run: |
          npm ci
          npm run test:unit
          npm run test:coverage

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          files: ./services/api-gateway/coverage/lcov.info
          flags: api-gateway
          name: api-gateway-coverage

      - name: Build and push to ECR
        uses: docker/build-push-action@v5
        with:
          context: services/api-gateway
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/api-gateway:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/api-gateway:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.ECR_REGISTRY }}/api-gateway:${{ github.sha }}
          format: spdx-json
          output-file: api-gateway-sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: api-gateway-sbom
          path: api-gateway-sbom.spdx.json

  # =============================================================================
  # Build User Service
  # =============================================================================
  build-user-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.user-service == 'true' }}
    defaults:
      run:
        working-directory: services/user-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export to Docker
        uses: docker/build-push-action@v5
        with:
          context: services/user-service
          load: true
          tags: user-service:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: user-service:test
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: ${{ env.TRIVY_SEVERITY }}
          exit-code: '1'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run unit tests
        run: |
          go mod download
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          files: ./services/user-service/coverage.out
          flags: user-service
          name: user-service-coverage

      - name: Build and push to ECR
        uses: docker/build-push-action@v5
        with:
          context: services/user-service
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/user-service:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/user-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =============================================================================
  # Build Order Service
  # =============================================================================
  build-order-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.order-service == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('services/order-service/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Run tests
        working-directory: services/order-service
        run: ./mvnw test

      - name: Generate coverage report
        working-directory: services/order-service
        run: ./mvnw jacoco:report

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          files: ./services/order-service/target/site/jacoco/jacoco.xml
          flags: order-service
          name: order-service-coverage

      - name: Build Docker image
        working-directory: services/order-service
        run: ./mvnw spring-boot:build-image -Dspring-boot.build-image.imageName=order-service:test

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: order-service:test
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: ${{ env.TRIVY_SEVERITY }}
          exit-code: '1'

      - name: Push to ECR
        run: |
          docker tag order-service:test ${{ env.ECR_REGISTRY }}/order-service:${{ github.sha }}
          docker tag order-service:test ${{ env.ECR_REGISTRY }}/order-service:latest
          docker push ${{ env.ECR_REGISTRY }}/order-service:${{ github.sha }}
          docker push ${{ env.ECR_REGISTRY }}/order-service:latest

  # =============================================================================
  # Validate Kubernetes Manifests
  # =============================================================================
  validate-kubernetes:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.kubernetes == 'true' || needs.detect-changes.outputs.helm == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.29.0'

      - name: Validate Kubernetes manifests
        run: |
          find kubernetes -name '*.yaml' -exec kubectl apply --dry-run=client -f {} \;

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Lint Helm charts
        run: |
          for chart in helm/charts/*/; do
            helm lint "$chart"
          done

      - name: Template Helm charts
        run: |
          for chart in helm/charts/*/; do
            helm template test "$chart" > /dev/null
          done

      - name: Run kubeval
        uses: instrumenta/kubeval-action@master
        with:
          files: kubernetes

      - name: Run kube-score
        run: |
          wget -O kube-score https://github.com/zegl/kube-score/releases/download/v1.17.0/kube-score_1.17.0_linux_amd64
          chmod +x kube-score
          ./kube-score score kubernetes/base/deployments/*.yaml || true

  # =============================================================================
  # Integration Tests
  # =============================================================================
  integration-tests:
    runs-on: ubuntu-latest
    needs: [build-api-gateway, build-user-service]
    if: always() && (needs.build-api-gateway.result == 'success' || needs.build-user-service.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kind
        uses: helm/kind-action@v1
        with:
          cluster_name: integration-tests
          config: .github/kind-config.yaml

      - name: Install Istio
        run: |
          curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.20.0 sh -
          export PATH=$PWD/istio-1.20.0/bin:$PATH
          istioctl install --set profile=demo -y
          kubectl label namespace default istio-injection=enabled

      - name: Deploy services
        run: |
          kubectl apply -f kubernetes/base/namespaces/
          kubectl apply -f kubernetes/base/configmaps/
          kubectl apply -f kubernetes/base/services/
          kubectl wait --for=condition=ready pod -l app=api-gateway -n api-gateway --timeout=300s

      - name: Run integration tests
        run: |
          npm install -g newman
          newman run tests/integration/api-gateway.postman_collection.json

      - name: Run contract tests
        run: |
          npm install -g @pact-foundation/pact-node
          pact-verifier \
            --provider-base-url http://localhost:8080 \
            --pact-broker-base-url ${{ secrets.PACT_BROKER_URL }} \
            --provider "api-gateway" \
            --provider-app-version ${{ github.sha }}

  # =============================================================================
  # Security Scan
  # =============================================================================
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform,kubernetes,dockerfile
          output_format: sarif
          output_file_path: reports/checkov.sarif

      - name: Run TFSec
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: terraform
          format: sarif
          out: reports/tfsec.sarif

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/cwe-top-25

      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: reports/

  # =============================================================================
  # Notify
  # =============================================================================
  notify:
    runs-on: ubuntu-latest
    needs: [build-api-gateway, build-user-service, build-order-service, validate-kubernetes, integration-tests]
    if: always()
    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#ci-cd'
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Update deployment status
        uses: chrnorm/deployment-status@v2
        if: github.ref == 'refs/heads/main'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          state: ${{ needs.integration-tests.result == 'success' && 'success' || 'failure' }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
